#! /bin/sh

CACHEDIR=/var/cache/pacman/pkg

main() {
    shell_init
    local refresh sync upgrade
    while test "$#" -gt 0; do
        local opt="$1" next
        case "$opt" in
        -[^-]?*)
            next="${opt#-?}"
            opt="${opt%"$next"}"
            ;;
        *)
            unset next
            ;;
        esac
        
        case "$opt" in
        -S | --sync)
            sync="$opt"
            ;;
        -y | --refresh)
            refresh="$opt"
            ;;
        -U | --upgrade)
            upgrade="$opt"
            ;;
        *)
            break
            ;;
        esac
        
        shift
        set -- ${next+-"$next"} "$@"
    done
    
    local pkgs
    if test -n "${upgrade+set}"; then
        pkgs="$(printf '%s\n' "$@")"
    else
        pacman ${sync+"$sync"} ${refresh+"$refresh"} --downloadonly "$@"
        
        pkgs="$(pacman ${sync+"$sync"} --print "$@")"
        pkgs="$(
            while read -r pkg; do
                echo "$CACHEDIR/$(basename -- "$pkg")"
            done << INPUT
$pkgs
INPUT
        )"
    fi
    
    unset WORK
    trap onexit EXIT
    
    while read -r pkg; do
        WORK="$(mktemp --tmpdir --directory roopwn.XXXXXXXXXX)"
        echo >&2
        echo >&2 "Analysing:" "$pkg"
        local files file deps missing fail
        files="$(tar xvf "$pkg" -C "$WORK" --exclude ".*" --anchored)"
        while read -r file; do
            workfile="$WORK/$file"
            
            if ! {
                test -x "$workfile" &&
                interp="$(
                    readelf --program-headers -- "$workfile" 2> /dev/null)"
            } then
                continue
            fi
            interp="$(sed -n \
            's/^ *\[Requesting program interpreter: \([^]]*\)\].*$/\1/p' \
                << INPUT
$interp
INPUT
            )"
            if test ! -e; then
                echo >&2 "$file: $interp: interp not found"
                fail=set
            fi
            
            needed="$(readelf --dynamic -- "$workfile")"
            # TODO: handle dynamic entries with RPATH and RUNPATH tags
            needed="$(sed -n \
            's/^ *[^ ]\+ *(NEEDED) *Shared library: \[\([^]]*\)\].*$/\1/p' \
                << INPUT
$deps
INPUT
            )"
            # TODO: handle absolute path; expand $ORIGIN
            
            echo >&2 "$file: needed: $deps"
            fail=set
        done << INPUT
$files
INPUT
        onexit
    done << INPUT
$pkgs
INPUT
    
    if test -n "${fail-}"; then
        return 1
    fi
    
    IFS="$NL"
    pacman --upgrade $pkgs
}

onexit() {
    if test -n "${WORK+set}"; then
        rm -rf -- "$WORK"
    fi
    unset WORK
}

shell_init() {
    set -o errexit -o nounset
NL='
'
}

main "$@"

<< 'PYTHON'
#! /usr/bin/env python3

from sys import argv
from subprocess import check_call

def main():
    through = list()
    refresh = []
    args = iter(argv[1:])
    for arg in args:
        through.append(arg)  # By default
        if arg == "--":
            through.extend(args)
            break
        if arg.startswith("--"):
            if arg == "--refresh":
                through.pop()
                refresh = [arg]
        elif arg.startswith("-"):
            for c in arg[1:]:
                if c == y
    check_call("pacman --downloadonly".split() + refresh + args)
    
    for arg in args:
        if not arg.startswith("-"):
            continue
        
        if arg == "--refresh":
            continue

if __name__ == "__main__":
    main()
PYTHON
